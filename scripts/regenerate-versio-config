#!/usr/bin/env zx

// TODO: make this script recursive, e.g. if worker depends on custom-tracing
// and backend depends on worker then backend should also depends on
// custom-tracing.

$.verbose = false

const {stdout: data} = await $`cat ./versio-projects.json`

let config = JSON.parse(data);

const idxOf = (name) => config.map(({name}) => name).indexOf(name);

let projects = config.flatMap(({ name, path, deps }, idx) =>
`  - name: "${name}"
    id: ${idx}
    labels: cargo
    changelog: "CHANGELOG.html"
    root: "${path}"
    version:
      file: "Cargo.toml"
      toml: "package.version"
    hooks:
      post_write: cargo update --workspace
${deps?.length >= 1 ? '    depends:' : ''}
${deps?.map((dep) => `      ${idxOf(dep)}:
        size: patch
        files:
          - file: "Cargo.toml"
            toml: "package.version"
`).join('\n') ?? ''}
`.split('\n')).filter(Boolean).join('\n');

const wholeFile = `# This file was autogenerated!!
# modify .versio-projects.json instead and re-run the command 'just update-versio-config'

options:
  prev_tag: "prev"

projects:
${projects}

sizes:
  major: [ "!" ]
  minor: [ feat, revert ]
  patch: [ fix, build, refactor, style ]
  none: [ release, chore, infra, docs, test ]
  fail: ["*"]

commit:
  message: "release: updating packages version"
  author: "Versio"
  email: "github.com/chaaz/versio"
`

await $`echo ${wholeFile} > .versio.yaml`
